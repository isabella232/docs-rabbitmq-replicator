#RabbitMQ Replicator for PCF
Welcome to the DRAFT documentation for the RabbitMQ Replicator. This tool allows you to install multiple RabbitMQ for PCF tiles in a single Ops Manager environment, which enables running multiple preprovisioned RabbitMQ clusters that are isolated from each other. For example, you may wish to isolate the cluster serving Spring Cloud Services (SCS) from the cluster serving apps in the marketplace, or you may wish to give a certain team their own dedicated preprovisioned cluster that you manage for them. Scroll to the end or click on "Common Use Cases" for more on how to accomplish this. 

<aside class="notice">
The on-demand service broker is currently disabled in replica tiles generated by the Replicator. If you wish to offer the on-demand service plans, please use the unreplicated RabbitMQ for PCF tile.
</aside>


##Installing the Replicator
The replicator can be downloaded from Pivotal Network and binaries are available for Linux, Mac, and Windows operating systems. You will need to download the archive, uncompress it, and run the binary appropriate for your operating system. 

<aside class="warning">
Please ensure that you have sufficient disk space. The RabbitMQ for PCF tile is over 1.2 gigabytes in size, so you will need at least 2.5 gigabytes to successfully use the replicator.
</aside>

##Using the Replicator
###Prerequisites
1. RabbitMQ for PCF replicator utility
2. RabbitMQ for PCF version 1.8.x or 1.9.x

###Generating replica tiles

> Syntax for using the replicator

```mac
./rabbitmq-replicator-darwin\
--name {YOUR_DESIRED_TILE_NAME}\
--path {PATH_TO_TILE}\
--output {DESIRED_FILE_NAME}.pivotal
```

The RabbitMQ replicator expects the following flags

| **Flag** | **Description**                                                                                                                                   |
|----------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| name     | The desired unique identifier for the replica tile, which is used to generate manifests, deployment names, and marketplace name for the service. Only alphanumeric characters and "-" are accepted by the tool. |
| path     | The location of the RabbitMQ source tile that you downloaded                                                                                                         |
| output   | The desired filename and path for the replica tile                                                                                              |


###Installing replica tiles

Once you have generated a replica tile, you can upload it to Ops Manager as you would any other tile. After you have uploaded it, follow the instructions for configuring and installing RabbitMQ for PCF

###Upgrading replica tiles

> Example initial installation

```mac
./rabbitmq-replicator-darwin\
--name trading-team\
--path /download/p-rabbitmq-v1.pivotal\
--output /output/p-rabbitmq-v1-trading-team.pivotal
```
> After the tile has been installed in Ops Manager, v2 is released and I need to run the replicator again before uploading the new tile to Ops Manager for an in-place upgrade

```mac
./rabbitmq-replicator-darwin\
--name trading-team\
--path /download/p-rabbitmq-v2.pivotal\
--output /output/p-rabbitmq-v2-trading-team.pivotal
```
> I can now upload the renamed tile to Ops Manager and proceed with upgrading the cluster

replica tiles can be upgraded like regular tiles with one important caveat. You will need to run the newer version of the RabbitMQ tile through the Replicator and give it the same name as the existing replica tile.

For instance, if you used the replicator to generate a replica of v1 of the RabbitMQ tile with the name "trading-team", and you installed it in Ops Manager, when you want to upgrade to v2, you'll need to run the replicator on v2 of the RabbitMQ tile and supply the same name. Once you have a replica v2 tile with the name "trading-team", you can upload it to Ops Manager, which will then upgrade the v1 tile. This is the workflow for upgrading the tile in-place. If you'd like to do a blue green style upgrade, see below.

##Common use cases

###Using the RabbitMQ replicator to create isolation
![alt text](/images/flowchart.png)

###Running SCS on a dedicated RabbitMQ cluster
To avoid contention between apps using Spring Cloud Services, which use RabbitMQ as a backing service, and apps that use RabbitMQ in the marketplace, we recommend that you use the unreplicated Rabbit tile solely for Spring Cloud Services (i.e. [turn off the errand that exposes this broker in the marketplace](http://docs.pivotal.io/rabbitmq-cf/1-9/install-config.html#post-deploy-errands)). If you want to offer RabbitMQ as a cloud messaging service in the marketplace, you can create one or several replicas, install them in Ops Manager, and either allow the broker registrar errand to run, or [register the service manually using CF](https://docs.pivotal.io/pivotalcf/1-10/services/managing-service-brokers.html#register-broker). Please note that replica RabbitMQ tiles cannot be used to provide a backing service for Spring Cloud Services (SCS), since SCS expects that the service is called ‘p-rabbitmq’. If you wish to isolate the RabbitMQ cluster being used by SCS from other tenants, you can reserve the default tile for SCS as shown in the diagram above, and add additional replica RabbitMQ clusters for use by apps in the marketplace. 

###Providing a preprovisioned dedicated cluster
To reserve a RabbitMQ cluster for use by a specific team, all you need to do is [disable the broker registrar errand in Ops Manager](http://docs.pivotal.io/rabbitmq-cf/1-9/install-config.html#post-deploy-errands) (located in the "errands" section of the tile). This will prevent service registration in the marketplace. Once the tile has been deployed, you can [manually expose the service broker to your desired orgs and spaces](https://docs.pivotal.io/pivotalcf/1-10/services/managing-service-brokers.html#register-broker). 

###Using replicants while offering the on-demand RabbitMQ service
Please note that the On-Demand service is not offered in replica tiles, since the purpose of the replicator is to create additional pre-provisioned clusters. If you wish to offer on-demand service plans, please use the default (unreplicated) RabbitMQ tile as shown in the diagram above. 

###Blue-green upgrades (Advanced)
In order to perform Blue-Green style updates to minimize downtime, you can stand up a new cluster, and migrate data and users over to the new cluster over an appropriate period of time. Please speak with your Platform Architect about how to enable this workflow.

